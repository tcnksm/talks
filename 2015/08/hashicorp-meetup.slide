Go packages from Hashicorp
Hashicorp meetup@Wantedly
5 Aug 2015

deeeet
@deeeet
http://deeeet.com/

* About me

.image deeeet.png 200 _

- *@deeeet* / *@tcnksm*
- [[http://deeeet.com][http://deeeet.com]]
- ç¤¾å†…PaaSï¼ˆCloudFoundryã‚’åˆ©ç”¨ï¼‰ã®é–‹ç™ºé‹ç”¨
- ï¼ˆCFã®ä¸­ã§ConsulãŒæ¡ç”¨ã•ã‚Œã‚‹äºˆå®šï¼‰

* TL;DR

[[https://github.com/hashicorp][Hashicorp]] / [[https://github.com/mitchellh][mitchellh]]æ°ãŒé–‹ç™ºã—ã¦ã„ã‚‹Go pacakgeã‚’ç´¹ä»‹ã™ã‚‹

* Goal

- Goè¨€èªã‚’ä½¿ã£ã¦ã‚‹ã²ã¨... ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è‰¯ã•ãã†!
- Goè¨€èªã‚’ä½¿ã£ã¦ãªã„ãŒãŒHashicorpãƒ„ãƒ¼ãƒ«ã¯ä½¿ã£ã¦ã„ã‚‹ã²ã¨... Hashicorpãƒ„ãƒ¼ãƒ«ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚‚å¤šã„ï¼ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã†ã¨ãã®å‚è€ƒã«!


* Packages

è‡ªåˆ†ãŒæ¡ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®/è§¦ã£ãŸã“ã¨ã®ã‚ã‚‹ã‚‚ã®ã‚’ç´¹ä»‹ã™ã‚‹

- [[https://github.com/mitchellh/cli][mitchellh/cli]]
- [[https://github.com/mitchellh/go-homedir][mitchellh/go-homedir]]
- [[https://github.com/mitchellh/colorstring][mitchellh/colorstring]]
- [[https://github.com/hashicorp/logutils][hashicorp/logutils]]
- [[https://github.com/mitchellh/panicwrap][mitchellh/panicwrap]]
- [[https://github.com/mitchellh/mapstructure][mitchellh/mapstructure]]
- [[https://github.com/mitchellh/copystructure][mitchellh/copystructure]]
- [[https://github.com/hashicorp/go-immutable-radix][hashicorp/go-immutable-radix]]

* mitchellh/cli

ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ä»˜ãã®CLIãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚‹ãŸã‚ã®Packageï¼Hashicorpãƒ„ãƒ¼ãƒ«ï¼ˆe.g., [[https://packer.io/][packer]]ï¼Œ[[https://www.consul.io/][Consul]]ï¼Œ[[https://www.terraform.io/][Terraform]]ï¼‰ã®åŸºæœ¬ã®éª¨æ ¼ã¯ã“ã®Packageã«ã‚ˆã£ã¦ä½œã‚‰ã‚Œã¦ã„ã‚‹ï¼è¨˜è¿°ã¯[[https://github.com/codegangsta/cli][codegangsta/cli]]ã‚ˆã‚Šå¤šã„ãŒãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„ãªã©Goã«æ…£ã‚Œã¦ã‚‹ãªã‚‰ã“ã¡ã‚‰ã®æ–¹ãŒä½¿ã„ã‚„ã™ã„(ã¨æ€ã†)ï¼

ä»¥ä¸‹ã®interfaceã‚’æº€ãŸã™ã‚ˆã†ã«ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ãï¼

  type Command interface {
      // -h ã‚ªãƒ—ã‚·ãƒ§ãƒ³(e.g., packer -h)ã§å„ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã®æ¦‚è¦ã‚’ä¸€è¡Œã§è¡¨ç¤ºã™ã‚‹ï¼
      // ãã“ã§å‡ºåŠ›ã™ã‚‹ç°¡å˜ãªãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜è¿°ã™ã‚‹ï¼
      Synopsis() string

      // ã‚ˆã‚Šè©³ç´°ãªãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜è¿°ã™ã‚‹ï¼
      // e.g., packer build -h
      Help() string

      // å®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã™ã‚‹ï¼å¼•æ•°([]string)ã‚’å—ã‘å–ã‚Šçµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™ï¼
      Run(args []string) int      
  }

* mitchellh/cli

Hashicorpãƒ„ãƒ¼ãƒ«ãªã‚‰command/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«å„ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã®interfaceå®Ÿè£…ãŒã‚ã‚‹

  $ cd $GOPATH/src/github.com/mitchellh/packer
  $ ls command/
    build.go       command_test.go  fix_test.go  meta.go  push_test.go   validate.go   
    build_test.go  fix.go           inspect.go   push.go  test-fixtures  validate_test.go

ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ãã¯ã“ã“ã‹ã‚‰å§‹ã‚ã‚Œã°è‰¯ã„ï¼‰

* mitchellh/go-homedir

Homeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—ã™ã‚‹ãŸã‚ã®Packageï¼ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’Homeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ããŸã„å ´åˆãªã©ã«ä½¿ãˆã‚‹ï¼

æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚‚ã‚‚ã¡ã‚ã‚“å–å¾—ã§ãã‚‹ãŒ[[https://golang.org/cmd/cgo/][cgo]]ã«ä¾å­˜ã—ã¦ãŠã‚Šã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨å®Ÿè¡Œæ™‚ã«æ­»ã¬ï¼

  userInfo, _ := user.Current()
  userInfo.HomeDir

go-homedirã¯ç’°å¢ƒå¤‰æ•°ãªã©ã‚’åˆ©ç”¨ã—ã¦OSã®å·®åˆ†ã‚’å¸åã™ã‚‹ï¼

  homedir.Dir()

* mitchellh/colorstring

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã«è‰²ä»˜ã‘ã‚’ã™ã‚‹ãŸã‚ã®Packageï¼ã‚·ãƒ³ãƒ—ãƒ«ãªinline syntaxãŒä½¿ãˆã‚‹ï¼

  text := `
    [red]colorstring[reset] is a [blue][bold]Go[reset] library for outputting colored strings
    to a console. using a simple inline syntax in your string to specify the color to print as.
  `
  colorstring.Fprintf(os.Stdout, text)

.image colorstring.png _ 900

* hashicorp/logutils

æ¨™æº–ã®log packageã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãŸãã•ã‚“ã‚ã‚‹ï¼ãŒï¼Œã©ã‚Œã‚‚é‡ã™ããŸã‚Šã™ã‚‹... logutilsã¯ãã®ä¸­ã§ã‚‚è»½ãã¦è‰¯ã„

  filter := &logutils.LevelFilter{
      Levels: []logutils.LogLevel{"DEBUG", "WARN", "ERROR"}, // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®å®šç¾©
      MinLevel: logutils.LogLevel("WARN"), // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š
      Writer: os.Stderr,
  }  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã—ã¦æ¨™æº–ã®logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ç™»éŒ²ã™ã‚‹ã ã‘
  log.SetOutput(filter) 
  
  log.Print("[DEBUG] Debugging") // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¯WARNãªã®ã§è¡¨ç¤ºã•ã‚Œãªã„
  log.Print("[WARN] Warning")    // è¡¨ç¤ºã•ã‚Œã‚‹ ğŸ™†
  log.Print("[ERROR] Erring")    // è¡¨ç¤ºã•ã‚Œã‚‹ ğŸ™†

* mitchellh/panicwrap

PanicãŒç™ºç”Ÿã—ãŸéš›ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œã™ã‚‹ã—ã‚ã‚‰ã‹ã˜ã‚ç™»éŒ²ã—ã¦ãŠã„ãŸHanlderé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆãƒªã‚«ãƒãƒ¼ã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ï¼‰ï¼

ã©ã†ä½¿ã†ã®ãŒè‰¯ã„?

- Panicæ™‚ã®Stacktraceã‚’è¡¨ç¤ºã™ã‚‹ã®ã§ã¯ãªãã‚ˆã‚ŠHelpfulãªè¡¨ç¤ºã‚’è¡Œã†ï¼
- ã©ã®ã‚ˆã†ãªçŠ¶æ³ã§PanicãŒç™ºç”Ÿã—ãŸã‹ã‚’è©³ç´°ã«è¨˜éŒ²ã™ã‚‹ï¼


* mitchellh/panicwrap

ã‚‚ã£ã¨ã‚‚å˜ç´”ãªä½¿ã„æ–¹ï¼

  func main() {
      // (1) Handler(panicãŒç™ºç”Ÿã—ãŸã¨ãã«å®Ÿè¡Œã™ã‚‹)ã‚’ç™»éŒ²ã™ã‚‹ï¼
      exitStatus, _ := panicwrap.BasicWrap(handler)

      // (2) PanicãŒç™ºç”Ÿã—ãŸå ´åˆã¯exitStatusã¯0ä»¥ä¸Šã®å€¤ã«ãªã‚Šã“ã“ã§çµ‚äº†ã™ã‚‹ï¼
      if exitStatus >= 0 {
          os.Exit(exitStatus)
      }

      // (3) é€šå¸¸ã®ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…
      panic("Panic happend here...")
  }

  func handler(output string) {
      f, _ := os.Create("crash.log")
      fmt.Fprintf(f, "The child panicked!\n\n%s",output)
      os.Exit(1)
  }

(å‚è€ƒ: [[http://deeeet.com/writing/2015/04/17/panicwrap/][Goè¨€èªã®CLIãƒ„ãƒ¼ãƒ«ã®panicã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ¬ãƒãƒ¼ãƒˆã‚’ã¤ãã‚‹ | SOTA]])


* mitchellh/mapstructure (reflectæŠ€1)

Genericãªmap(map[string]interface{})ã‚’ç‰¹å®šã®structã«Decodeã™ã‚‹ãŸã‚ã®Packageï¼

*ãªãœ?* ... ãƒ‡ãƒ¼ã‚¿(e.g., JSON)ã®æ§‹é€ ãŒã‚ã‚‰ã‹ã˜ã‚åˆ†ã‹ã£ã¦ã„ã‚Œã°æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ãã‚Œã‚’Decodeã™ã‚‹ã®ã¯å®¹æ˜“ã„ãŒï¼Œæ§‹é€ ãŒä¸æ˜ç¢ºãªå ´åˆã¯å³ã—ããªã‚‹ï¼ã“ã®å ´åˆDecodeãŒ2å›å¿…è¦ã«ãªã‚‹ï¼1å›ç›®ã®Decodeã§ãã®ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ï¼ˆç¨®é¡ï¼‰ã‚’åˆ¤åˆ¥ã—2å›ç›®ã«ç‰¹å®šã®Structã¸Decodeã™ã‚‹ï¼mapstructureã¯ã“ã‚Œã‚’ç°¡å˜ã«ã™ã‚‹ï¼

Hashicorpãƒ„ãƒ¼ãƒ«ã§ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„APIã®Decodeã§å¤šç”¨ã•ã‚Œã¦ã„ã‚‹ï¼

* mitchellh/mapstructure (reflectæŠ€1)

ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ï¼ˆã‚ˆã‚Šè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚‚ã£ã¨å¨åŠ›ã‚’ç™ºæ®ã—ãã†ï¼‰ï¼

  type Person struct {
      Name   string
      Age    int
      Emails []string
      Extra  map[string]string
  }

  // æ§‹é€ ãŒä¸æ˜ã®ãƒ‡ãƒ¼ã‚¿(e.g., JSON)ï¼map[string]interface{}ã¨ã—ã¦Decodeã—ã¦ãŠãï¼
  input := map[string]interface{}{
      "name":   "Mitchell",
      "age":    91,
      "emails": []string{"one", "two", "three"},
      "extra": map[string]string{
          "twitter": "mitchellh",
      },
  }

  var result Person
  _ := Decode(input, &result)
  
  fmt.Printf("%#v", result)


* mitchellh/copystructure (reflectæŠ€2)

mapã‚„sliceï¼Œpointerã¨ã„ã£ãŸå‚ç…§å‹ã®å€¤ã®Deep Copyã‚’è¡Œã†Packageï¼

  input := map[string]interface{}{
      "bob": map[string]interface{}{
          "emails": []string{"a", "b"},
       },
  }

  dup, _ := Copy(input)

  fmt.Printf("%#v", dup)


[[https://www.terraform.io/][Terraform]]ã®Configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ”ãƒ¼ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼

* hashicorp/go-immutable-radix

[[https://ja.wikipedia.org/wiki/%E5%9F%BA%E6%95%B0%E6%9C%A8][åŸºæ•°æœ¨ï¼ˆRadix treeï¼‰]]ã®Goå®Ÿè£…ï¼ãƒˆãƒ©ã‚¤æœ¨ã¨ã¯ç•°ãªã‚Šã¯1ã¤ã®æ–‡å­—ã ã‘ã§ãªãæ–‡å­—ã®ä¸¦ã³ãŒãƒ©ãƒ™ãƒ«ã¨ã—ã¦ä»˜ä¸ã•ã‚Œã‚‹ï¼é›†åˆãŒå°ã•ã„å ´åˆï¼ˆç‰¹ã«é•·ã„æ–‡å­—åˆ—ã®é›†åˆï¼‰ã‚„é•·ã„æ¥é ­éƒ¨ã‚’å…±æœ‰ã™ã‚‹æ–‡å­—åˆ—ã®é›†åˆãªã©ã§åŠ¹æœã‚’ç™ºæ®ã™ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¨ã‹ï¼‰ï¼

  r := iradix.New()
  r, _, _ = r.Insert(([]byte)("foo/"), "read")
  r, _, _ = r.Insert(([]byte)("bar/"), "write")
  r, _, _ = r.Insert(([]byte)("foo/bar"), "write")

  _, policy, ok := r.Root().LongestPrefix([]byte("foo/zip"))
  if ok {
      fmt.Println(policy) // read
  }

[[][Consul]]ã§ACLã®keyã®Loolupã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼ˆ[[https://github.com/armon/go-radix][armon/go-radix]]ï¼‰


* ä»–ã«ã‚‚

- [[https://github.com/mitchellh/ioprogress][mitchellh/ioprogress]]
- [[https://github.com/mitchellh/reflectwalk][mitchellh/reflectwalk]]
- [[https://github.com/hashicorp/memberlist][hashicorp/memberlist]]
- [[https://github.com/hashicorp/raft][hashicorp/raft]]
- [[https://github.com/hashicorp/yamux][hashicorp/yamux]]
