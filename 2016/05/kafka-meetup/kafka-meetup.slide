Log pipeline for Cloud Foundry with Apache Kafka
Apache Kafka Meetup Japan #1 at Yahoo! JAPAN
31 May 2016

Taichi Nakashima
@deeeet

* About me

.image img/deeeet.png 200 _

- *@deeeet* (Twitter) / *@tcnksm* (GitHub)
- [[http://deeeet.com][http://deeeet.com]]
- PaaS (based on Cloud Foundry) Dev&Ops 
- Gopher

* About me

.image img/blog.png 550 _

* TL;DR

- ãªãœLog pipelineã®æ§‹ç¯‰ã«Apache Kafkaã‚’æ¡ç”¨ã—ãŸã‹?
- (ã©ã®ã‚ˆã†ã«CloudFoundryã¨é€£æºã—ã¦ã„ã‚‹ã®ã‹?)

* Cloud Foundry

[[https://www.cloudfoundry.org/][https://www.cloudfoundry.org/]]

- OSS Platform as a Service æ§‹ç¯‰åŸºç›¤
- APIã‚„ãƒ«ãƒ¼ã‚¿ï¼ŒCLIãƒ„ãƒ¼ãƒ«ï¼Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼Œèªè¨¼æ©Ÿæ§‹etc
- Heroku buildpackã‚’åˆ©ç”¨ã—æ§˜ã€…ãªruntimeã«å¯¾å¿œ
- Docker imageã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‚‚å¯¾å¿œï¼ˆroot FSã®åˆ©ç”¨ï¼‰
- v1 (Ruby) -> v2 (Golang)

Cloud Foundryã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

    $ cf push APP                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    $ cf scale APP -i 4          # ã‚¢ãƒ—ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚±ãƒ¼ãƒ«
    $ cf logs APP                # ãƒ­ã‚°(stdout/stderr)ã®ç¢ºèª
    $ cf cf bind-service APP DB  # DBã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨

* Why log pipeline?

PaaSã®åˆ©ç”¨è€…ã«å¯¾ã—ã¦

- `cf logs` ã‚³ãƒãƒ³ãƒ‰ã§ã¯ç›´è¿‘ã®ãƒ­ã‚°ã—ã‹ç¢ºèªã§ããªã„ï¼é•·æœŸçš„ã«ãƒ­ã‚°ã‚’ä¿å­˜ã—ãƒ¦ãƒ¼ã‚¶ãŒä½¿ã„ãŸã„ãƒ­ã‚°ã«ã„ã¤ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„
- ELKãªã©ãƒ¦ãƒ¼ã‚¶ãŒä½¿ã„ãŸã„ãƒ­ã‚°è§£æãƒ„ãƒ¼ãƒ«ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„

PaaSã®é‹ç”¨è€…ã«å¯¾ã—ã¦

- Cloud Foundryè‡ªä½“ã®ãƒ‡ãƒãƒƒã‚°ã‚’æ¥½ã«ã—ãŸã„ï¼ˆå¯è¦–åŒ–ãªã©ï¼‰

ä»–ã®ãƒãƒ¼ãƒ ã«å¯¾ã—ã¦

- ä¾‹ãˆã°ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã®ãŸã‚ã«ãƒ‡ãƒ¼ã‚¿è§£æãƒãƒ¼ãƒ ã¸ãƒ­ã‚°ã‚’æä¾›ã—ãŸã„

* What kind of log?

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚° - ãƒ¦ãƒ¼ã‚¶ãŒpushã—ãŸã‚¢ãƒ—ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿæˆã™ã‚‹ãƒ­ã‚°
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ­ã‚° - Cloud Foundryã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆe.g., APIï¼‰ãŒç”Ÿæˆã™ã‚‹ãƒ­ã‚°

(2000 instances + 5TB logs / day)

* v1 -> v2

* v1

.image  http://techblog.rakuten.co.jp/images/cfv1.jpeg 400 _

* Problem

- ãƒ­ã‚°ã®ä¿å­˜å…ˆãŒ2ã¤ã«åˆ†æ•£ã—ã¦ã—ã¾ã£ãŸï¼ˆsyslogã‚µãƒ¼ãƒãƒ¼ + GlusterFSï¼‰ï¼å•é¡ŒãŒã‚ã£ãŸæ™‚ã«è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ
- ãƒ­ã‚°ã®è©°ã¾ã‚Šã¨ãã®ä¼æ¬ãŒç™ºç”Ÿã—ãŸï¼ˆupstreamãŒç®¡è½„å¤–ã®å ´åˆã¯ä½•ã‚‚ã§ããªã„ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãŒä½¿ã„ãŸã„ãƒ­ã‚°è§£æãƒ„ãƒ¼ãƒ«ã®å¯¾å¿œãŒå¤§å¤‰ã ã£ãŸï¼ˆLogstash or Flume etc...ï¼‰
- GlusterFS... ğŸ”¥

* v2

.image img/cfv2.jpeg 400 _

* Benefits

- Simple - ã™ã¹ã¦ã®ãƒ­ã‚°ã¯å¿…ãšKafkaã«ä¸€æ™‚çš„ã«ä¿å­˜ã•ã‚Œã‚‹ï¼æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã‚‚ã¨ã‚Šã‚ãˆãšKafkaã«é€ã‚Œã°è‰¯ã„ï¼ˆãƒ­ã‚°ã ã‘ã§ã¯ãªããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚é€ã£ã¦ã„ã‚‹ï¼‰
- Flexible - Kafkaã®Consumerã¯Pullå‹ãªã®ã§æ–°ã—ã„Backendã®ã‚·ã‚¹ãƒ†ãƒ ã‚’è¿½åŠ ã—ãŸã„ã¨ãã«Kafkaè‡ªä½“ã«æ‰‹ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒãªã„ï¼ˆæ–°ã—ã„ãƒ­ã‚°è§£æãƒ„ãƒ¼ãƒ«ã‚’è©¦ã™ã‚‚ã®å®¹æ˜“ï¼‰
- Reliable - ä¸€ã¤ã®Consumerã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã‚‚ãã®å•é¡ŒãŒKafkaã‚„ä»–ã®Consumerã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãŒãªã„ï¼

* Details

x2Kafka

- [[http://www.rsyslog.com/doc/master/configuration/modules/omkafka.html][rsyslog/omkafka]] (C/C++ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª[[https://github.com/edenhill/librdkafka][edenhill/librdkafka]]ã‚’åˆ©ç”¨)
- [[https://github.com/rakutentech/kafka-firehose-nozzle][rakutentech/kafka-firehose-nozzle]] (Golangã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸[[https://github.com/Shopify/sarama][Shopify/sarama]]ã‚’åˆ©ç”¨)
- Kafka ? (e.g., ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ )

Kafka2x

- [[https://github.com/pinterest/secor][pinterest/secor]] (Azure blob storeã«å¯¾å¿œ [[https://github.com/pinterest/secor/pull/194][#194]])
- ELK
- [[http://riemann.io/][riemann]] + [[https://influxdata.com/][InfluxDB]] + [[http://grafana.org/][Grafana]] (ãƒ¡ãƒˆãƒªã‚¯ã‚¹)
- Kafka ? ï¼ˆe.g., ãƒ‡ãƒ¼ã‚¿è§£æãƒãƒ¼ãƒ  or ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ï¼‰

* Future work

.image  http://techblog.rakuten.co.jp/images/multi-dc.jpeg 400 _
